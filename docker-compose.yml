services:
  microshop-postgres:
    image: postgres:15
    container_name: microshop-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      # 挂载初始化 SQL：在同一台 Postgres 上创建 users_db / products_db / orders_db 三个独立数据库
      # 这样每个微服务拥有自己的数据库，更符合“数据自治”的微服务设计
      - ./db-init:/docker-entrypoint-initdb.d

  microshop-redis:
    image: redis:7
    container_name: microshop-redis
    ports:
      - "6379:6379"

  microshop-rabbitmq:
    image: rabbitmq:3-management
    container_name: microshop-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"

  user-service:
    build: ./user-service
    container_name: user-service
    environment:
      # user-service 只访问自己的 users_db，而不是和其他服务共享一个 DB
      DATABASE_URL: postgresql+psycopg2://postgres:postgres@microshop-postgres:5432/users_db
    depends_on:
      - microshop-postgres
    ports:
      - "8001:8000"

  product-service:
    build: ./product-service
    container_name: product-service
    environment:
      # product-service 只访问 products_db，用于管理商品/库存数据
      DATABASE_URL: postgresql+psycopg2://postgres:postgres@microshop-postgres:5432/products_db
      # MQ 配置：监听订单事件后扣减库存
      RABBITMQ_URL: amqp://guest:guest@microshop-rabbitmq:5672/
      ORDER_EVENTS_EXCHANGE: order.events
      PRODUCT_ORDER_QUEUE: product-service.order-consumer
    depends_on:
      - microshop-postgres
    ports:
      - "8002:8000"

  order-service:
    build: ./order-service
    container_name: order-service
    environment:
      # order-service 只访问 orders_db，避免直接跨服务 JOIN，强制通过 API 协作
      DATABASE_URL: postgresql+psycopg2://postgres:postgres@microshop-postgres:5432/orders_db
      # HTTP 客户端配置（可选，如果不配置就用代码里的默认值）
      # 这样可以在不同环境（开发/测试/生产）用不同配置，不需要改代码
      USER_SERVICE_URL: http://user-service:8000/api/users
      PRODUCT_SERVICE_URL: http://product-service:8000/api/products
      # 超时时间（秒）：如果下游服务超过这个时间没响应，就放弃等待
      USER_SERVICE_TIMEOUT: "3.0"
      PRODUCT_SERVICE_TIMEOUT: "3.0"
      # 最大重试次数：网络抖动时自动重试
      USER_SERVICE_MAX_RETRIES: "3"
      PRODUCT_SERVICE_MAX_RETRIES: "3"
      # MQ 配置：订单服务只负责发布事件，库存等逻辑交给其他服务
      RABBITMQ_URL: amqp://guest:guest@microshop-rabbitmq:5672/
      ORDER_EVENTS_EXCHANGE: order.events
    depends_on:
      - microshop-postgres
      - user-service
      - product-service
    ports:
      - "8003:8000"

volumes:
  postgres-data:
