name: "Deploy User Service (CI/CD Full Flow)"

on:
  push:
    branches: [ main, master ]
    paths:
      - "services/user-service/**"
      - ".github/workflows/deploy-user-service.yml"
  workflow_dispatch:

permissions:
  contents: write    # æ›´æ–° Helm values éœ€è¦å†™æƒé™
  packages: write    # æŽ¨é•œåƒåˆ° GHCR éœ€è¦å†™æƒé™

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ toLower(github.repository_owner) }}
  SERVICE_NAME: user-service

jobs:
  # ==================== é˜¶æ®µ 1: Build & Push Docker Image ====================
  build:
    name: "Build & Push Docker Image"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ env.SERVICE_NAME }}
          tags: |
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./services/${{ env.SERVICE_NAME }}
          file: ./services/${{ env.SERVICE_NAME }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Show image tags
        run: |
          echo "Built image tags:"
          echo "${{ steps.meta.outputs.tags }}"

  # ==================== é˜¶æ®µ 2: Deploy (GitOps: update Helm values) ====================
  deploy:
    name: "GitOps Deploy (Update Helm values)"
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Install yq
        run: |
          wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x /usr/local/bin/yq
          yq --version

      - name: Update Helm values with new image tag
        env:
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_PREFIX: ${{ env.IMAGE_PREFIX }}
          SERVICE_NAME: ${{ env.SERVICE_NAME }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          echo "Updating Helm values for ${SERVICE_NAME} ..."
          # è®¾ç½®å…¨å±€é•œåƒä»“åº“
          yq eval -i '.global.imageRegistry = env(REGISTRY)' helm/microservices/values.yaml
          # æ›´æ–° user-service é•œåƒä»“åº“å’Œ tag
          yq eval -i '.userService.image.repository = env(IMAGE_PREFIX) + "/" + env(SERVICE_NAME)' helm/microservices/values.yaml
          yq eval -i '.userService.image.tag = env(GITHUB_SHA)' helm/microservices/values.yaml
          echo "Resulting userService.image:"
          yq eval '.userService.image' helm/microservices/values.yaml

      - name: Commit and push changes
        run: |
          git add helm/microservices/values.yaml
          if ! git diff --staged --quiet; then
            git commit -m "Update ${SERVICE_NAME} image to ${GITHUB_SHA} [skip ci]"
            git push
            echo "Changes pushed. ArgoCD will sync automatically."
          else
            echo "No changes to commit."
          fi
        env:
          SERVICE_NAME: ${{ env.SERVICE_NAME }}
          GITHUB_SHA: ${{ github.sha }}

      - name: Summary
        run: |
          {
            echo "## ðŸŽ‰ CI/CD Pipeline Completed"
            echo ""
            echo "### ðŸ“¦ Built Image"
            echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ env.SERVICE_NAME }}:${{ github.sha }}\`"
            echo ""
            echo "### ðŸ”„ GitOps Flow"
            echo "1. Docker image built and pushed to GHCR"
            echo "2. Helm values.yaml updated with new image tag"
            echo "3. Changes committed and pushed to Git"
            echo "4. ArgoCD will detect changes and sync to cluster"
          } >> "$GITHUB_STEP_SUMMARY"
