name: CI/CD Pipeline

# Trigger on push to main/master or pull requests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# Workflow permissions
permissions:
  contents: read
  checks: write

jobs:
  # Job 1: Validate Kubernetes YAML files (no kubectl, no cluster connection)
  validate-k8s-yaml:
    name: Validate Kubernetes YAML
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Validate YAML syntax
        shell: bash
        run: |
          echo "ðŸ” Validating Kubernetes YAML file syntax..."
          
          # Turn off bash -e, control error count manually
          set +e
          
          ERROR_COUNT=0
          # Skip CRD files (optional)
          SKIP_FILES=("prometheus-rule.yaml" "service-monitor.yaml")
          
          # Find all yaml/yml files in k8s directory
          find k8s \( -name "*.yaml" -o -name "*.yml" \) | while read file; do
            # Check if file should be skipped
            SKIP=false
            for skip_file in "${SKIP_FILES[@]}"; do
              if [[ "$file" == *"$skip_file" ]]; then
                SKIP=true
                break
              fi
            done
            
            if [ "$SKIP" = true ]; then
              echo "â­ï¸  Skipping $file (CRD / large file)"
              continue
            fi
            
            echo "Checking: $file"
            
            # Use Python + PyYAML for pure syntax parsing (no cluster connection)
            echo "import sys, yaml
path = sys.argv[1]
try:
    with open(path, 'r', encoding='utf-8') as f:
        list(yaml.safe_load_all(f))
    sys.exit(0)
except Exception as e:
    print(f'Error: {e}', file=sys.stderr)
    sys.exit(1)" | python3 - "$file"
            
            EXIT_CODE=$?
            
            if [ $EXIT_CODE -eq 0 ]; then
              echo "  âœ… Syntax validation passed"
            else
              echo "  âŒ YAML syntax error"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          done
          
          if [ $ERROR_COUNT -gt 0 ]; then
            echo "âŒ Found $ERROR_COUNT YAML file validation failures"
            exit 1
          fi
          
          echo "âœ… All Kubernetes YAML files validated successfully"

  # Job 2: Validate Helm Charts
  validate-helm-charts:
    name: Validate Helm Charts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Add Helm repositories
        run: |
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo add jaegertracing https://jaegertracing.github.io/helm-charts
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update

      - name: Lint observability-platform chart
        run: |
          echo "ðŸ” Validating observability-platform Helm Chart..."
          cd helm/observability-platform
          helm dependency update
          helm lint .
          echo "âœ… observability-platform Chart validation passed"

      - name: Template observability-platform chart
        run: |
          echo "ðŸ” Rendering observability-platform Helm Chart templates..."
          cd helm/observability-platform
          helm template observability-platform . --debug --dry-run > /dev/null || {
            echo "âŒ observability-platform Chart template rendering failed"
            exit 1
          }
          echo "âœ… observability-platform Chart template rendering succeeded"

      - name: Lint microservices chart
        run: |
          echo "ðŸ” Validating microservices Helm Chart..."
          cd helm/microservices
          helm lint .
          echo "âœ… microservices Chart validation passed"

      - name: Template microservices chart
        run: |
          echo "ðŸ” Rendering microservices Helm Chart templates..."
          cd helm/microservices
          helm template microservices . --debug --dry-run > /dev/null || {
            echo "âŒ microservices Chart template rendering failed"
            exit 1
          }
          echo "âœ… microservices Chart template rendering succeeded"

  # Job 3: Validate Python code (optional)
  validate-python:
    name: Validate Python Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          # Check if requirements.txt exists for each service
          for service in user-service product-service order-service; do
            if [ -f "services/$service/requirements.txt" ]; then
              echo "Installing $service dependencies..."
              pip install -r services/$service/requirements.txt
            fi
          done
          # Install code checking tools
          pip install flake8 pylint

      - name: Lint Python code
        run: |
          echo "ðŸ” Checking Python code style..."
          # Use flake8 to check code style (ignore some common warnings)
          if [ -d services ]; then
            flake8 services --max-line-length=120 --ignore=E501,W503 || {
              echo "âš ï¸  Code style check found issues, but not blocking build"
            }
          fi
          echo "âœ… Python code check completed"

      - name: Validate Python syntax
        run: |
          echo "ðŸ” Validating Python syntax..."
          if [ -d services ]; then
            find services -name "*.py" -exec python -m py_compile {} \; || {
              echo "âŒ Python syntax error"
              exit 1
            }
          fi
          echo "âœ… All Python files have correct syntax"

  # Job 4: Validate Dockerfiles (optional)
  validate-dockerfile:
    name: Validate Dockerfiles
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate Dockerfiles
        run: |
          echo "ðŸ” Validating Dockerfile syntax..."
          for dockerfile in services/*/Dockerfile; do
            if [ -f "$dockerfile" ]; then
              echo "Checking: $dockerfile"
              # Check Dockerfile basic structure
              if ! grep -q "^FROM " "$dockerfile"; then
                echo "âŒ $dockerfile missing FROM instruction"
                exit 1
              fi
              
              # Check if required instructions exist (COPY, ADD, or RUN)
              if ! grep -qE "^(COPY|ADD|RUN)" "$dockerfile"; then
                echo "âš ï¸  $dockerfile may be missing COPY/ADD/RUN instructions"
              fi
              
              echo "âœ… $dockerfile basic structure is correct"
            else
              echo "âš ï¸  Dockerfile not found: $dockerfile"
            fi
          done
          echo "âœ… All Dockerfiles validated successfully"

  # Job 5: Check documentation (optional)
  check-docs:
    name: Check Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Markdown files
        run: |
          echo "ðŸ” Checking Markdown documentation..."
          # Simple check for Markdown files with at least one first-level heading
          find . -name "*.md" -not -path "./.git/*" -exec grep -l "^# " {} \; | head -5 || true
          echo "âœ… Documentation check completed"

  # Job 6: Summary report
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [validate-k8s-yaml, validate-helm-charts, validate-python, validate-dockerfile]
    if: always()
    steps:
      - name: CI Summary
        run: |
          echo "## ðŸŽ‰ CI/CD Checks Completed" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Check Item | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Kubernetes YAML | ${{ needs.validate-k8s-yaml.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Helm Charts | ${{ needs.validate-helm-charts.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Python Code | ${{ needs.validate-python.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Dockerfiles | ${{ needs.validate-dockerfile.result }} |" >> "$GITHUB_STEP_SUMMARY"
          
          if [ "${{ needs.validate-k8s-yaml.result }}" != "success" ] || \
             [ "${{ needs.validate-helm-charts.result }}" != "success" ] || \
             [ "${{ needs.validate-python.result }}" != "success" ] || \
             [ "${{ needs.validate-dockerfile.result }}" != "success" ]; then
            echo "âŒ Some checks failed, please check detailed logs" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          else
            echo "âœ… All checks passed!" >> "$GITHUB_STEP_SUMMARY"
          fi
