name: CI/CD Pipeline

# è§¦å‘æ¡ä»¶ï¼šå½“ä»£ç æŽ¨é€åˆ° main/master åˆ†æ”¯æˆ–åˆ›å»º PR æ—¶è¿è¡Œ
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# å·¥ä½œæµæƒé™
permissions:
  contents: read
  checks: write

jobs:
  # Job 1: éªŒè¯ Kubernetes YAML æ–‡ä»¶
  validate-k8s-yaml:
    name: Validate Kubernetes YAML
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Validate YAML syntax
        run: |
          echo "ðŸ” éªŒè¯ Kubernetes YAML æ–‡ä»¶è¯­æ³•..."
          
          # å…³æŽ‰ bash -eï¼Œè‡ªå·±æŽ§åˆ¶é”™è¯¯æ•°é‡
          set +e
          
          ERROR_COUNT=0
          # éœ€è¦è·³è¿‡çš„ CRD ç±»å¤§æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
          SKIP_FILES=("prometheus-rule.yaml" "service-monitor.yaml")
          
          # æ‰¾å‡ºæ‰€æœ‰ k8s ç›®å½•ä¸‹çš„ yaml/yml æ–‡ä»¶
          find k8s -name "*.yaml" -o -name "*.yml" | while read file; do
            # åˆ¤æ–­æ˜¯ä¸æ˜¯è¦è·³è¿‡çš„æ–‡ä»¶
            SKIP=false
            for skip_file in "${SKIP_FILES[@]}"; do
              if [[ "$file" == *"$skip_file" ]]; then
                SKIP=true
                break
              fi
            done
            if [ "$SKIP" = true ]; then
              echo "â­ï¸  è·³è¿‡ $file (CRD / å¤§æ–‡ä»¶)"
              continue
            fi
            
            echo "æ£€æŸ¥: $file"
            
            # ç”¨ Python + PyYAML åšçº¯è¯­æ³•è§£æž
            python3 -c "
import sys, yaml
path = sys.argv[1]
try:
    with open(path, 'r', encoding='utf-8') as f:
        list(yaml.safe_load_all(f))
    sys.exit(0)
except Exception as e:
    print(f'é”™è¯¯: {e}', file=sys.stderr)
    sys.exit(1)
" "$file"
            EXIT_CODE=$?
            
            if [ $EXIT_CODE -eq 0 ]; then
              echo "  âœ… è¯­æ³•éªŒè¯é€šè¿‡"
            else
              echo "  âŒ YAML è¯­æ³•é”™è¯¯"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          done
          
          # ç»Ÿä¸€åœ¨æœ€åŽå†³å®šæ˜¯å¦è®© step å¤±è´¥
          if [ $ERROR_COUNT -gt 0 ]; then
            echo "âŒ å‘çŽ° $ERROR_COUNT ä¸ª YAML æ–‡ä»¶éªŒè¯å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… æ‰€æœ‰ Kubernetes YAML æ–‡ä»¶éªŒè¯é€šè¿‡"

  # Job 2: éªŒè¯ Helm Charts
  validate-helm-charts:
    name: Validate Helm Charts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Add Helm repositories
        run: |
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo add jaegertracing https://jaegertracing.github.io/helm-charts
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update

      - name: Lint observability-platform chart
        run: |
          echo "ðŸ” éªŒè¯ observability-platform Helm Chart..."
          cd helm/observability-platform
          helm dependency update
          helm lint .
          echo "âœ… observability-platform Chart éªŒè¯é€šè¿‡"

      - name: Template observability-platform chart
        run: |
          echo "ðŸ” æ¸²æŸ“ observability-platform Helm Chart æ¨¡æ¿..."
          cd helm/observability-platform
          helm template observability-platform . --debug --dry-run > /dev/null || {
            echo "âŒ observability-platform Chart æ¨¡æ¿æ¸²æŸ“å¤±è´¥"
            exit 1
          }
          echo "âœ… observability-platform Chart æ¨¡æ¿æ¸²æŸ“æˆåŠŸ"

      - name: Lint microservices chart
        run: |
          echo "ðŸ” éªŒè¯ microservices Helm Chart..."
          cd helm/microservices
          helm lint .
          echo "âœ… microservices Chart éªŒè¯é€šè¿‡"

      - name: Template microservices chart
        run: |
          echo "ðŸ” æ¸²æŸ“ microservices Helm Chart æ¨¡æ¿..."
          cd helm/microservices
          helm template microservices . --debug --dry-run > /dev/null || {
            echo "âŒ microservices Chart æ¨¡æ¿æ¸²æŸ“å¤±è´¥"
            exit 1
          }
          echo "âœ… microservices Chart æ¨¡æ¿æ¸²æŸ“æˆåŠŸ"

  # Job 3: éªŒè¯ Python ä»£ç ï¼ˆå¯é€‰ï¼‰
  validate-python:
    name: Validate Python Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          # æ£€æŸ¥æ¯ä¸ªæœåŠ¡çš„ requirements.txt æ˜¯å¦å­˜åœ¨
          for service in user-service product-service order-service; do
            if [ -f "services/$service/requirements.txt" ]; then
              echo "å®‰è£… $service ä¾èµ–..."
              pip install -r services/$service/requirements.txt
            fi
          done
          # å®‰è£…ä»£ç æ£€æŸ¥å·¥å…·
          pip install flake8 pylint

      - name: Lint Python code
        run: |
          echo "ðŸ” æ£€æŸ¥ Python ä»£ç é£Žæ ¼..."
          # ä½¿ç”¨ flake8 æ£€æŸ¥ä»£ç é£Žæ ¼ï¼ˆå¿½ç•¥ä¸€äº›å¸¸è§è­¦å‘Šï¼‰
          find services -name "*.py" -exec flake8 {} \; --max-line-length=120 --ignore=E501,W503 || {
            echo "âš ï¸  ä»£ç é£Žæ ¼æ£€æŸ¥å‘çŽ°é—®é¢˜ï¼Œä½†ä¸é˜»æ­¢æž„å»º"
          }
          echo "âœ… Python ä»£ç æ£€æŸ¥å®Œæˆ"

      - name: Validate Python syntax
        run: |
          echo "ðŸ” éªŒè¯ Python è¯­æ³•..."
          find services -name "*.py" -exec python -m py_compile {} \; || {
            echo "âŒ Python è¯­æ³•é”™è¯¯"
            exit 1
          }
          echo "âœ… æ‰€æœ‰ Python æ–‡ä»¶è¯­æ³•æ­£ç¡®"

  # Job 4: éªŒè¯ Dockerfileï¼ˆå¯é€‰ï¼‰
  validate-dockerfile:
    name: Validate Dockerfiles
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate Dockerfiles
        run: |
          echo "ðŸ” éªŒè¯ Dockerfile è¯­æ³•..."
          for dockerfile in services/*/Dockerfile; do
            if [ -f "$dockerfile" ]; then
              echo "æ£€æŸ¥: $dockerfile"
              # æ£€æŸ¥ Dockerfile åŸºæœ¬ç»“æž„
              if ! grep -q "^FROM " "$dockerfile"; then
                echo "âŒ $dockerfile ç¼ºå°‘ FROM æŒ‡ä»¤"
                exit 1
              fi
              
              # æ£€æŸ¥æ˜¯å¦æœ‰å¿…éœ€çš„æŒ‡ä»¤ï¼ˆCOPY, ADD, æˆ– RUNï¼‰
              if ! grep -qE "^(COPY|ADD|RUN)" "$dockerfile"; then
                echo "âš ï¸  $dockerfile å¯èƒ½ç¼ºå°‘ COPY/ADD/RUN æŒ‡ä»¤"
              fi
              
              # ä½¿ç”¨ docker buildx å°è¯•è§£æž Dockerfileï¼ˆä¸å®žé™…æž„å»ºï¼‰
              # æ³¨æ„ï¼š--dry-run å¯èƒ½ä¸æ”¯æŒï¼Œæ‰€ä»¥æˆ‘ä»¬åªåšåŸºæœ¬è¯­æ³•æ£€æŸ¥
              echo "âœ… $dockerfile åŸºæœ¬ç»“æž„æ­£ç¡®"
            else
              echo "âš ï¸  æœªæ‰¾åˆ° Dockerfile: $dockerfile"
            fi
          done
          echo "âœ… æ‰€æœ‰ Dockerfile éªŒè¯é€šè¿‡"

  # Job 5: æ£€æŸ¥æ–‡æ¡£é“¾æŽ¥ï¼ˆå¯é€‰ï¼‰
  check-docs:
    name: Check Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Markdown files
        run: |
          echo "ðŸ” æ£€æŸ¥ Markdown æ–‡æ¡£..."
          # æ£€æŸ¥æ˜¯å¦æœ‰æ˜Žæ˜¾çš„ Markdown è¯­æ³•é”™è¯¯ï¼ˆç®€å•æ£€æŸ¥ï¼‰
          find . -name "*.md" -not -path "./.git/*" -exec grep -l "^# " {} \; | head -5
          echo "âœ… æ–‡æ¡£æ£€æŸ¥å®Œæˆ"

  # Job 6: æ€»ç»“æŠ¥å‘Š
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [validate-k8s-yaml, validate-helm-charts, validate-python, validate-dockerfile]
    if: always()
    steps:
      - name: CI Summary
        run: |
          echo "## ðŸŽ‰ CI/CD æ£€æŸ¥å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ£€æŸ¥é¡¹ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Kubernetes YAML | ${{ needs.validate-k8s-yaml.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Helm Charts | ${{ needs.validate-helm-charts.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Code | ${{ needs.validate-python.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dockerfiles | ${{ needs.validate-dockerfile.result }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.validate-k8s-yaml.result }}" != "success" ] || \
             [ "${{ needs.validate-helm-charts.result }}" != "success" ] || \
             [ "${{ needs.validate-python.result }}" != "success" ] || \
             [ "${{ needs.validate-dockerfile.result }}" != "success" ]; then
            echo "âŒ éƒ¨åˆ†æ£€æŸ¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼" >> $GITHUB_STEP_SUMMARY
          fi

