name: CI/CD Pipeline

# Trigger on push to main/master or pull requests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# Workflow permissions
permissions:
  contents: read
  checks: write

jobs:

  # Job 1: Validate Kubernetes YAML syntax (no kubectl)
  validate-k8s-yaml:
    name: Validate Kubernetes YAML
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Validate YAML syntax
        shell: bash
        run: |
          echo "ðŸ” Validating Kubernetes YAML file syntax..."

          set +e
          ERROR_COUNT=0

          SKIP_FILES=("prometheus-rule.yaml" "service-monitor.yaml")

          find k8s \( -name "*.yaml" -o -name "*.yml" \) | while read file; do
            SKIP=false
            for skip_file in "${SKIP_FILES[@]}"; do
              if [[ "$file" == *"$skip_file" ]]; then
                SKIP=true
                break
              fi
            done

            if [ "$SKIP" = true ]; then
              echo "â­ï¸  Skipping $file"
              continue
            fi

            echo "Checking: $file"

            python3 -c "import sys, yaml; path = sys.argv[1]; exec('try:\n    with open(path, \"r\", encoding=\"utf-8\") as f:\n        list(yaml.safe_load_all(f))\n    sys.exit(0)\nexcept Exception as e:\n    print(f\"Error: {e}\", file=sys.stderr)\n    sys.exit(1)')" "$file"

            EXIT_CODE=$?

            if [ $EXIT_CODE -eq 0 ]; then
              echo "  âœ… Syntax validation passed"
            else
              echo "  âŒ YAML syntax error"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          done

          if [ $ERROR_COUNT -gt 0 ]; then
            echo "âŒ Found $ERROR_COUNT YAML validation failures"
            exit 1
          fi

          echo "âœ… All Kubernetes YAML files validated successfully"

  # Job 2: Validate Helm Charts
  validate-helm-charts:
    name: Validate Helm Charts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.13.0'
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Add Helm repositories
        run: |
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo add jaegertracing https://jaegertracing.github.io/helm-charts
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update

      - name: Lint observability-platform chart
        run: |
          echo "ðŸ” Linting observability-platform chart..."
          cd helm/observability-platform
          if [ ! -f Chart.yaml ]; then
            echo "âŒ Chart.yaml missing in $(pwd)"
            exit 1
          fi
          helm dependency update
          helm lint .
          echo "âœ… Lint OK"

      - name: Template observability-platform chart
        run: |
          echo "ðŸ” Rendering observability-platform templates..."
          cd helm/observability-platform
          helm template observability-platform . --debug --dry-run > /dev/null
          echo "âœ… Template OK"

      - name: Lint microservices chart
        run: |
          echo "ðŸ” Linting microservices chart..."
          cd helm/microservices
          helm lint .
          echo "âœ… Lint OK"

      - name: Template microservices chart
        run: |
          echo "ðŸ” Rendering microservices templates..."
          cd helm/microservices
          helm template microservices . --debug --dry-run > /dev/null
          echo "âœ… Template OK"

  # Job 3: Validate Python code
  validate-python:
    name: Validate Python Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          for service in user-service product-service order-service; do
            if [ -f "services/$service/requirements.txt" ]; then
              echo "Installing $service dependencies..."
              pip install -r services/$service/requirements.txt
            fi
          done
          pip install flake8 pylint

      - name: Lint Python code
        run: |
          echo "ðŸ” Running flake8..."
          if [ -d services ]; then
            flake8 services --max-line-length=120 --ignore=E501,W503 || true
          fi
          echo "âœ… Python lint completed"

      - name: Validate Python syntax
        run: |
          echo "ðŸ” Checking Python syntax..."
          if [ -d services ]; then
            find services -name "*.py" -exec python -m py_compile {} \;
          fi
          echo "âœ… Python syntax OK"

  # Job 4: Validate Dockerfiles
  validate-dockerfile:
    name: Validate Dockerfiles
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate Dockerfile syntax
        run: |
          echo "ðŸ” Validating Dockerfiles..."
          for dockerfile in services/*/Dockerfile; do
            if [ -f "$dockerfile" ]; then
              echo "Checking: $dockerfile"

              if ! grep -q "^FROM " "$dockerfile"; then
                echo "âŒ $dockerfile missing FROM instruction"
                exit 1
              fi

              if ! grep -qE "^(COPY|ADD|RUN)" "$dockerfile"; then
                echo "âš ï¸  $dockerfile missing COPY/ADD/RUN"
              fi

              echo "âœ… Structure OK"
            fi
          done

  # Job 5: Documentation check
  check-docs:
    name: Check Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Markdown
        run: |
          echo "ðŸ” Checking Markdown headings..."
          find . -name "*.md" -exec grep -l "^# " {} \; | head -5 || true
          echo "âœ… Markdown check OK"

  # Job 6: CI Summary
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [validate-k8s-yaml, validate-helm-charts, validate-python, validate-dockerfile]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## ðŸŽ‰ CI/CD Checks Completed" >> "$GITHUB_STEP_SUMMARY"
          echo "| Item | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Kubernetes YAML | ${{ needs.validate-k8s-yaml.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Helm Charts | ${{ needs.validate-helm-charts.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Python Code | ${{ needs.validate-python.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Dockerfiles | ${{ needs.validate-dockerfile.result }} |" >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ needs.validate-k8s-yaml.result }}" != "success" ] || \
             [ "${{ needs.validate-helm-charts.result }}" != "success" ] || \
             [ "${{ needs.validate-python.result }}" != "success" ] || \
             [ "${{ needs.validate-dockerfile.result }}" != "success" ]; then
            echo "âŒ Some checks failed" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          else
            echo "âœ… All checks passed!" >> "$GITHUB_STEP_SUMMARY"
          fi
