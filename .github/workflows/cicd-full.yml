name: "üöÄ Full CI/CD Pipeline (Lint ‚Üí Build ‚Üí Test ‚Üí Scan ‚Üí Deploy)"

on:
  push:
    branches: [ main, master ]
    paths:
      - "services/**"
      - "helm/**"
      - ".github/workflows/**"
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  checks: write

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}

jobs:
  # ==================== Lint ====================
  lint:
    name: "üîç Lint & Validate"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Kubernetes YAML
        run: |
          echo "üîç Validating Kubernetes YAML..."
          pip install pyyaml
          find k8s \( -name "*.yaml" -o -name "*.yml" \) \
            -not -name "*prometheus-rule.yaml" \
            -not -name "*service-monitor.yaml" \
            | while read file; do
                python3 -c "import yaml, sys; yaml.safe_load_all(open('$file'))" || exit 1
              done
          echo "‚úÖ Kubernetes YAML validation passed"

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: "3.13.0"

      - name: Validate Helm Charts
        run: |
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo add jaegertracing https://jaegertracing.github.io/helm-charts
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update
          echo "üîç Validating microservices chart..."
          helm lint helm/microservices
          helm template test helm/microservices --dry-run > /dev/null
          echo "üîç Validating observability chart..."
          cd helm/observability-platform
          helm dependency update
          helm lint .
          helm template test . --dry-run > /dev/null
          cd ../..
          echo "‚úÖ Helm charts OK"

      - name: Lint Python Code
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
        run: |
          pip install flake8 pylint
          for svc in user-service product-service order-service; do
            if [ -d "services/$svc" ]; then
              flake8 services/$svc --max-line-length=120 || true
              find services/$svc -name "*.py" -exec python -m py_compile {} \;
            fi
          done
          echo "‚úÖ Python OK"

  # ==================== Build ====================
  build:
    name: "üèóÔ∏è Build Docker Images"
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        service: [user-service, product-service, order-service]
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}
          tags: |
            type=sha,prefix={{branch}}-

      - name: Build and push image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./services/${{ matrix.service }}
          file: ./services/${{ matrix.service }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}

      - run: echo "Image pushed: ${{ steps.meta.outputs.tags }}"

  # ==================== Test ====================
  test:
    name: "üß™ Run Tests"
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [user-service, product-service, order-service]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          cd services/${{ matrix.service }}
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest

      - name: Basic import test
        run: |
          cd services/${{ matrix.service }}
          python - <<EOF
import sys
sys.path.insert(0, '.')
print("Import OK")
EOF

  # ==================== Scan ====================
  scan:
    name: "üîí Security Scan"
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [user-service, product-service, order-service]
    steps:
      - uses: actions/checkout@v4

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}:latest
          format: sarif
          output: trivy.sarif

      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy.sarif

  # ==================== Deploy ====================
  deploy:
    name: "üöÄ GitOps Deploy"
    runs-on: ubuntu-latest
    needs: [build, test, scan]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install yq
        run: |
          wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x /usr/local/bin/yq

      - name: Update Helm values
        run: |
          yq -i '.global.imageRegistry="${{ env.REGISTRY }}"' helm/microservices/values.yaml
          for svc in user-service product-service order-service; do
            yq -i ".${svc//-Service/}.image.repository=\"${{ env.IMAGE_PREFIX }}/$svc\"" helm/microservices/values.yaml
          done

      - name: Commit changes
        run: |
          git add helm/microservices/values.yaml
          git commit -m "Update images to ${{ github.sha }} [skip ci]" || true
          git push

  # ==================== Summary ====================
  summary:
    name: "üìä Summary"
    runs-on: ubuntu-latest
    needs: [lint, build, test, scan, deploy]
    if: always()
    steps:
      - run: |
          echo "## üéâ CI/CD Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Lint: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Test: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Scan: ${{ needs.scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deploy: ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
